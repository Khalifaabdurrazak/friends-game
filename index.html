<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Most Likely To - Friends Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f4f4f9; margin: 0; }
        h1, h2 { color: #333; }
        button { padding: 15px 25px; margin: 10px; font-size: 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background: #ccc; opacity: 0.6; cursor: not-allowed; }
        .player-button { 
            display: block; width: 85%; max-width: 400px; margin: 15px auto; padding: 25px; font-size: 24px; 
            background: #e3f2fd; border: 3px solid #2196f3; border-radius: 12px; cursor: pointer;
            white-space: normal; word-break: break-word;
        }
        .player-button:disabled { background: #bbb; border-color: #999; color: #666; }
        .player-button.selected { background: #fff59d; border-color: #fbc02d; }
        .progress-container { 
            margin: 20px auto; width: 85%; max-width: 500px; text-align: left; 
        }
        .progress-container > div:first-child { 
            white-space: normal; word-break: break-word; font-size: 18px; 
        }
        .progress-bar-bg { background: #ddd; height: 40px; border-radius: 8px; overflow: hidden; }
        .progress-bar { background: #4caf50; height: 100%; width: 0; transition: width 0.4s; color: white; line-height: 40px; text-align: center; font-weight: bold; }
        #adminControls { background: #fff8e1; padding: 20px; border: 2px solid #ffca28; border-radius: 10px; margin: 20px auto; max-width: 600px; }
        input { padding: 12px; width: 80%; max-width: 500px; font-size: 18px; margin: 10px; }
        #revealText { font-size: 32px; margin: 30px; white-space: pre-line; }
        #personalText { font-size: 48px; color: #d32f2f; margin: 20px; }
        #timer { font-size: 36px; font-weight: bold; color: #d32f2f; margin: 20px; }
    </style>
</head>
<body>

<div id="joinScreen">
    <h1>Most Likely To</h1>
    <p>Tap your name to join:</p>
    <div id="nameButtons"></div>
    <button onclick="location.reload()">Refresh List</button>
</div>

<div id="waitingScreen" style="display:none">
    <h1>Waiting for admin to start...</h1>
    <div id="joinedPlayers"></div>
    <button onclick="location.reload()">Refresh</button>
</div>

<div id="votingScreen" style="display:none">
    <h2 id="currentQuestion"></h2>
    <div id="timer">--</div>
    <div id="voteButtons"></div>
    <h3>Live Votes</h3>
    <div id="progressBars"></div>
</div>

<div id="revealScreen" style="display:none">
    <h1 id="revealText"></h1>
    <h2 id="personalText"></h2>
    <div id="adminNext" style="display:none; margin-top:50px;">
        <button id="newRoundBtn">Start New Round</button><br><br>
        <button id="shareBtn">Share Result to WhatsApp Group</button>
    </div>
</div>

<div id="adminControls" style="display:none">
    <h2>Admin Control</h2>
    <input id="questionInput" placeholder="Who is most likely to..."><br><br>
    <button id="startRoundBtn">Start Round</button>
</div>

<script>
    // ==== EDIT THESE IF NEEDED ====
    const PLAYER_NAMES = ["abdurrazak zikirullahi Khalifa", "Tijani Fauziyah omolola", "Sulaimon quadri Opeyemi", "Ibrahim Aleeyat Kofoworola", "Olarinde zaynab omotolani", "Oluwanifemi", "Ibrahim Abdulrazak", "abdullahi"];
    const DURATION = 45; // seconds
    const ADMIN_SECRET = "cyberkalitheadmin";
    const SUPABASE_URL = "https://hfvkogevgapyjnmanbmh.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_MJUzJ-XS272Vmb4gD8sbBQ_1RJ9bq3N";
    // ===============================

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const channel = supabase.channel('game-channel');

    let myName = localStorage.getItem('myName');
    let isAdmin = false;
    let currentQuestion = null;
    let startTime = null;
    let votes = {};
    let takenNames = [];

    // Admin check
    const params = new URLSearchParams(location.search);
    if (params.get('admin') === ADMIN_SECRET) {
        isAdmin = true;
        document.getElementById('adminControls').style.display = 'block';
    }

    // Realtime listeners
    channel
        .on('presence', { event: 'sync' }, () => {
            const state = channel.presenceState();
            takenNames = [];
            Object.values(state).forEach(presences => {
                presences.forEach(p => {
                    if (p.name) takenNames.push(p.name);
                });
            });
            takenNames = [...new Set(takenNames)];
            updateJoinButtons();
            updateJoinedPlayers();
            updateProgressBars();
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, (payload) => {
            if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                votes[payload.new.voter] = payload.new.target;
            } else if (payload.eventType === 'DELETE') {
                delete votes[payload.old.voter];
            }
            updateVoteButtons();
            updateProgressBars();
            updateView();
        })
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'game_state' }, (payload) => {
            if (payload.new.id === 1) {
                currentQuestion = payload.new.question || null;
                startTime = payload.new.start_time || null;
                updateView();
            }
        })
        .subscribe();

    // Initial data load
    async function loadGameState() {
        const { data } = await supabase.from('game_state').select('*').eq('id', 1).maybeSingle();
        if (data) {
            currentQuestion = data.question;
            startTime = data.start_time;
        }
        updateView();
    }

    async function loadVotes() {
        const { 
data } = await supabase.from('votes').select('voter, target');
        votes = {};
        if (data) data.forEach(row => votes[row.voter] = row.target);
        updateProgressBars();
        updateVoteButtons();
    }

    // Auto-rejoin + initial setup
    window.onload = async () => {
        updateJoinButtons(); // build name buttons
        await loadGameState();
        await loadVotes();
        if (myName && PLAYER_NAMES.includes(myName) && !takenNames.includes(myName)) {
            await channel.track({ name: myName });
            showScreen('waitingScreen');
        } else if (myName) {
            showScreen('waitingScreen');
        }
    };

    window.onbeforeunload = () => channel.untrack();

    // Big tappable name buttons for joining
    function updateJoinButtons() {
        const container = document.getElementById('nameButtons');
        if (!container.dataset.built) {
            container.innerHTML = '';
            PLAYER_NAMES.forEach(name => {
                const btn = document.createElement('button');
                btn.className = 'player-button';
                btn.textContent = name;
                btn.onclick = async () => {
                    if (takenNames.includes(name)) return;
                    const { error } = await channel.track({ name });
                    if (error) return alert("Failed to join - try again");
                    myName = name;
                    localStorage.setItem('myName', myName);
                    showScreen('waitingScreen');
                };
                container.appendChild(btn);
            });
            container.dataset.built = true;
        }
        // Always update disabled state
        container.querySelectorAll('.player-button').forEach(btn => {
            btn.disabled = takenNames.includes(btn.textContent);
        });
    }

    function updateJoinedPlayers() {
        document.getElementById('joinedPlayers').innerHTML = '<h3>Joined: ' + (takenNames.length ? takenNames.join(', ') : 'No one yet') + '</h3>';
    }

    function showScreen(id) {
        ['joinScreen','waitingScreen','votingScreen','revealScreen'].forEach(s => document.getElementById(s).style.display = 'none');
        document.getElementById(id).style.display = 'block';
    }

    function updateView() {
        if (!myName) {
            showScreen('joinScreen');
            return;
        }
        if (!currentQuestion || !startTime) {
            showScreen('waitingScreen');
            return;
        }
        const timeLeft = Math.max(0, Math.ceil((startTime + DURATION * 1000 - Date.now()) / 1000));
        document.getElementById('currentQuestion').textContent = currentQuestion;

        if (timeLeft > 0) {
            showScreen('votingScreen');
            document.getElementById('timer').textContent = `Time left: ${timeLeft}s`;
            createVoteButtons();
        } else {
            showScreen('revealScreen');
            createVoteButtons(); // keep buttons visible but disabled
            computeAndShowWinner();
            if (isAdmin) document.getElementById('adminNext').style.display = 'block';
        }
    }

    function createVoteButtons() {
        const container = document.getElementById('voteButtons');
        if (container.dataset.built) return;
        container.innerHTML = '';
        PLAYER_NAMES.forEach(name => {
            const btn = document.createElement('button');
            btn.className = 'player-button';
            btn.textContent = name;
            btn.onclick = async () => {
                if (name === myName) return alert("No self-voting! ðŸ˜");
                await supabase.from('votes').upsert({ voter: myName, target: name });
            };
            container.appendChild(btn);
        });
        container.dataset.built = true;
        updateVoteButtons();
    }

    function updateVoteButtons() {
        const buttons = document.querySelectorAll('#voteButtons .player-button');
        const timeLeft = startTime ? Math.max(0, Math.ceil((startTime + DURATION * 1000 - Date.now()) / 1000)) : 0;
        buttons.forEach((btn, i) => {
            const name = PLAYER_NAMES[i];
            btn.disabled = timeLeft === 0;
            btn.classList.toggle('selected', votes[myName] === name);
        });
    }

    function updateProgressBars() {
        let container = document.getElementById('progressBars');
        if (!container.innerHTML) {
            container.innerHTML = '';
            PLAYER_NAMES.forEach(name => {
                container.innerHTML += `
                    <div class="progress-container">
                        <div><strong>${name}</strong>: <span class="count">0</span> votes</div>
                        <div class="progress-bar-bg"><div class="progress-bar">0%</div></div>
                    </div>`;
            });
        }
        const counts = {};
        PLAYER_NAMES.forEach(n => counts[n] = 0);
        Object.values(votes).forEach(v => counts[v]++);
        const totalVotes = Object.keys(votes).length || 1;
        container.querySelectorAll('.progress-container').forEach((el, i) => {
            const name = PLAYER_NAMES[i];
            const count = counts[name];
            const percent = (count / totalVotes) * 100;
            el.querySelector('.count').textContent = count;
            el.querySelector('.progress-bar').style.width = percent + '%';
            el.querySelector('.progress-bar').textContent = percent.toFixed(0) + '%';
        });
    }

    function computeAndShowWinner() {
        const counts = {};
        PLAYER_NAMES.forEach(n => counts[n] = 0);
        Object.values(votes).forEach(v => counts[v]++);
        const maxCount = Math.max(...Object.values(counts));
        const winners = PLAYER_NAMES.filter(n => counts[n] === maxCount);

        let revealText = '';
        let personalText = '';
        let doConfetti = false;

        if (maxCount === 0) {
            revealText = 'No votes yet!';
        } else if (winners.length === 1) {
            revealText = `The winner of "${currentQuestion}" is...\n${winners[0]}!`;
            if (myName === winners[0]) {
                personalText = 'CONGRATULATIONS!\nYOU WON! ðŸŽ‰ðŸŽ‰';
                doConfetti = true;
            }
        } else {
            let list = winners.slice(0, -1).join(', ');
            if (winners.length > 2) list += ',';
            list += ' and ' + winners[winners.length - 1];
            revealText = `It's a TIE between ${list}!`;
            if (winners.includes(myName)) {
                personalText = 'YOU TIED FOR FIRST! ðŸŽ‰';
                doConfetti = true;
            }
        }

        document.getElementById('revealText').textContent = revealText;
        document.getElementById('personalText').textContent = personalText;

        if (doConfetti) {
            confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
        }
    }

    // Admin controls
    if (isAdmin) {
        document.getElementById('startRoundBtn').onclick = async () => {
            const q = document.getElementById('questionInput').value.trim();
            if (!q) return alert("Enter a question!");
            const now = Date.now();
            await supabase.from('game_state').update({ question: q, start_time: now }).eq('id', 1);
            await supabase.from('votes').delete();
            document.getElementById('questionInput').value = '';
        };
        document.getElementById('newRoundBtn').onclick = async () => {
            await supabase.from('game_state').update({ question: null, start_time: null }).eq('id', 1);
        };
        document.getElementById('shareBtn').onclick = () => {
            const resultText = document.getElementById('revealText').textContent;
            const text = `Most Likely To Result ðŸ”¥\n\n"${currentQuestion}"\n\n${resultText}\n\nThe group has spoken! ðŸ˜‚`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`);
        };
    }
</script>
</body>
</html>